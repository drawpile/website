(()=>{(function(){let{username:n,frameancestors:r}=document.querySelector("#auth").dataset,a=(r||"").trim().split(/\s+/);function i(e){document.querySelector("#auth-message").textContent=e}async function u(e,o){try{let t=await fetch("/api/ext-auth/",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":getCookie("csrftoken")},body:JSON.stringify(e)});if(t.status!==200)throw new Error(`Server responded with status ${t.status}.`);let s=await t.json();if(s.status==="badpass")throw new Error("Not logged in.");if(s.status==="banned")throw new Error("Banned.");if(s.status==="outgroup")throw new Error("Not in the required group.");if(s.status!=="auth")throw new Error(`Unknown status '${s.status}'.`);if(!s.token||typeof s.token!="string")throw new Error("Missing token.");window.parent.postMessage({type:"auth-identified",token:s.token},o)}catch(t){console.error(t),i(`Authentication failed: ${t.message}`)}}window.addEventListener("message",e=>{if(a.includes(e.origin))if(e.data?.type==="auth-authenticate"){let t={...e.data.args,username:n,password:!1};u(t,e.origin)}else console.error("Unknown message type",e);else console.error("Origin not allowed",e)}),window.parent.postMessage({type:"auth-username-selected",username:n},"*")})();})();
